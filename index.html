<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>札幌ホテルリスト</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#c0c0c0">
<style>
body{
  font-family:Meiryo,'メイリオ',sans-serif;
  background:linear-gradient(145deg,#c0c0c0,#e0e0e0);
  margin:0;
  padding:16px;
}

/* ===== NHKニュース（最上部） ===== */
#newsBoard {
  background:#000;
  border-radius:5px;
  padding:6px 0;
  overflow:hidden;
  white-space:nowrap;
  text-align:left;
  margin:-8px -8px 10px -8px;
}
#newsContent {
  display:inline-block;
  padding-left:100%;
  color:#ffa500;
  font-family:'MS Gothic','Osaka-Mono',monospace;
  font-weight:bold;
  font-size:1.05em;
  animation: scrollNews 60s linear infinite;
}
@keyframes scrollNews {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}
#newsBoard:hover #newsContent { animation-play-state: paused; }

/* ===== 更新日時 ===== */
#updateTime {
  text-align:right;
  font-size:0.8em;
  color:#000;
  opacity:0.7;
  margin:-5px 8px 10px 0;
}

h1{font-size:28px;text-shadow:0 1px 0 #fff;margin:8px 0;}
.metal{
  width:40px;height:40px;
  border-radius:50%;
  border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;margin:0 5px;
}
#topBtns{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}
#newsLine{margin:4px auto 10px;text-align:center;}
#newsTicker{overflow:hidden;white-space:nowrap;box-sizing:border-box;
  border-top:1px solid rgba(255,255,255,.35);
  border-bottom:1px solid rgba(0,0,0,.25);padding:6px 0;}
#newsTicker span{display:inline-block;padding-left:100%;
  animation:ticker 20s linear infinite;font-weight:700;
  font-size:1.05em;color:#222;}
@keyframes ticker{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}
.btns{display:grid;grid-template-columns:repeat(5,60px);
  gap:14px;justify-content:center;margin:10px auto;}
.metal-round{width:60px;height:60px;border-radius:50%;border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  font-weight:700;}
.alpha{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
  max-width:520px;margin:6px auto 12px;}
.long{padding:10px 20px;border-radius:9999px;border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);font-weight:700;}
#results{max-width:1000px;margin:10px auto;text-align:left;}
.card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:10px;margin:8px 0;}
.name{font-weight:700;}
#speedArea{text-align:center;font-weight:bold;margin:6px 0;}
#addHome{
  position:fixed;left:10px;bottom:10px;
  padding:8px 12px;border-radius:10px;border:2px solid #777;
  background:linear-gradient(#fff,#ccc);z-index:5;
}
#overlay,#modal,#qrModal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;
  align-items:center;justify-content:center;z-index:200;}
#overlay{background:rgba(0,0,0,0.7);z-index:100;}
#overlay-content{background:#fff;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto;text-align:center;position:relative;}
#overlay-content button{background:#fff;border:2px solid #999;border-radius:8px;color:#333;font-size:1.1em;padding:10px 15px;margin:5px;cursor:pointer;}
#overlay-close{position:absolute;top:10px;right:10px;background:#999;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer;}
#modal{background:rgba(0,0,0,0.8);}
#modal-content{background:#fff;padding:20px;border-radius:10px;max-width:90%;text-align:left;}
#qrModal{background:rgba(0,0,0,0.7);z-index:300;}
#qrBox{background:#fff;padding:20px;border-radius:10px;text-align:center;}
#qrBox canvas{width:180px;height:180px;}
.instruction{text-align:center;color:#666;margin:20px 0;font-size:16px;}

/* ホテルブランドボタン */
.hotel-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 520px;
  margin: 12px auto 20px;
}
.hotel-btn {
  padding: 10px 0;
  border-radius: 6px;
  border: 2px solid #999;
  background: linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  font-weight: 700;
  font-size: 1em;
  box-shadow: 0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  cursor: pointer;
}

/* 下部ボタン */
#bottomBtns{
  position:fixed;
  right:10px;
  bottom:10px;
  display:flex;
  gap:10px;
  z-index:10;
}
.metal-small{
  width:40px;height:40px;
  border-radius:50%;
  border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- ===== NHKニュース電光掲示板（最上部） ===== -->
<div id="newsBoard"><div id="newsContent">📻 NHKニュースを取得中...</div></div>
<div id="updateTime">更新: --:--</div>

<div id="topBtns">
  <button class="metal" onclick="location.href='bbs.html'">💬</button>
  <button class="metal" id="qrBtn">📱</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=日ハム+試合結果','_blank')">⚾</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=新千歳空港+運行状況','_blank')">✈</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=札幌+天気','_blank')">☁</button>
  <button class="metal" id="speedBtn">🧭</button>
  <button class="metal" onclick="toggleAdmin()">⚙</button>
</div>

<div style="text-align:center;">
  <h1>札幌ホテルリスト</h1>
</div>

<div id="newsLine"><div id="newsTicker"><span id="marqueeAll"></span></div></div>
<div id="speedArea"></div>

<div id="admin" style="display:none;text-align:center;margin-bottom:8px">
  <input type="password" id="pw" placeholder="管理者パス">
  <button onclick="checkAdmin()">ログイン</button>
</div>

<div class="btns" id="kanaBtns">
  <button class="metal-round" data-g="あ">あ</button><button class="metal-round" data-g="か">か</button><button class="metal-round" data-g="さ">さ</button><button class="metal-round" data-g="た">た</button><button class="metal-round" data-g="な">な</button><button class="metal-round" data-g="は">は</button><button class="metal-round" data-g="ま">ま</button><button class="metal-round" data-g="や">や</button><button class="metal-round" data-g="ら">ら</button><button class="metal-round" data-g="わ">わ</button>
</div>
<div class="alpha">
  <button class="long" data-g="ABCDE">ABCDE</button>
  <button class="long" data-g="FGHIJ">FGHIJ</button>
  <button class="long" data-g="KLMNO">KLMNO</button>
  <button class="long" data-g="PQRST">PQRST</button>
  <button class="long" data-g="UVWX">UVWX</button>
  <button class="long" data-g="YZ">YZ</button>
</div>

<!-- ホテルブランドボタン -->
<div class="hotel-grid">
  <button class="hotel-btn" data-brand="アパホテル">アパホテル</button>
  <button class="hotel-btn" data-brand="東横INN">東横INN</button>
  <button class="hotel-btn" data-brand="マイステイズ">マイステイズ</button>
  <button class="hotel-btn" data-brand="リブマックス">リブマックス</button>
  <button class="hotel-btn" data-brand="ルートイン">ルートイン</button>
  <button class="hotel-btn" data-brand="RANDOR">RANDOR</button>
</div>

<div class="instruction">🔍 上のボタンから検索を始めてください</div>
<div id="results"></div>

<div id="bottomBtns">
  <button class="metal-small" onclick="location.href='bbs.html'">💬</button>
  <button class="metal-small" onclick="toggleAdmin()">⚙️</button>
</div>

<button id="addHome">🏠 ホームに追加</button>

<div id="overlay">
  <div id="overlay-content">
    <button id="overlay-close" onclick="closeOverlay()">閉じる</button>
  </div>
</div>
<div id="modal"><div id="modal-content"></div></div>
<div id="qrModal"><div id="qrBox"><canvas id="qrCanvas"></canvas><br><button onclick="closeQR()">閉じる</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script>
/* ---------- ホーム追加対応 ---------- */
let installPromptEvent=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  installPromptEvent=e;
});
document.getElementById('addHome').addEventListener('click',()=>{
  if(installPromptEvent){
    installPromptEvent.prompt();
    installPromptEvent.userChoice.then(()=>installPromptEvent=null);
  }else if(/iphone|ipad|ipod/i.test(navigator.userAgent)){
    alert('Safariの共有メニューから「ホーム画面に追加」を選んでください。');
  }else{
    alert('ブラウザのメニューから「ホーム画面に追加」を選んでください。');
  }
});

/* ---------- 管理者 ---------- */
function toggleAdmin(){
  const a=document.getElementById('admin');
  a.style.display=a.style.display==='block'?'none':'block';
}
function checkAdmin(){
  if(document.getElementById('pw').value==='bando')
    location.href='manual_entry_form.html';
  else alert('NG');
}

/* ---------- CSV読み込み ---------- */
let DATA_ALL=[],DATA=[];
async function loadCSV(){
  try {
    const r=await fetch('hotels.csv');
    const t=await r.text();
    DATA_ALL=t.trim().split(/\r?\n/).filter(Boolean).map(l=>{
      const p=l.split(',');
      const hotelData = {
        initial:p[0]||'',
        name:p[1]||'',
        address:p[2]||'',
        note:p[3]||''
      };
      // ホテル名だけからキーワード生成
      hotelData.keywords = generateKeywordsFromName(hotelData.name);
      return hotelData;
    });
    DATA=DATA_ALL.slice();
    console.log('CSV読み込み成功:', DATA_ALL.length + '件');
  } catch(e) {
    console.error('CSV読み込みエラー:', e);
    DATA_ALL = [];
    DATA = [];
  }
}
// ページ読み込み時にCSVを読み込む
loadCSV();

/* ---------- ホテル名からキーワード生成 ---------- */
function generateKeywordsFromName(name) {
  return name
    .replace(/ホテル/g, ' ')
    .replace(/〈/g, ' ')
    .replace(/〉/g, ' ')
    .replace(/by/g, ' ')
    .replace(/[()（）]/g, ' ')
    .split(/\s+/)
    .filter(word => word && word.length > 1)
    .map(word => word.toLowerCase())
    .join(' ');
}

/* ---------- 地図リンク ---------- */
function mapLink(name){
  const ua=navigator.userAgent.toLowerCase();
  const q=encodeURIComponent(name);
  return /iphone|ipad|ipod/.test(ua)
    ? `maps://maps.apple.com/?q=${q}`
    : `https://www.google.com/maps/search/?api=1&query=${q}`;
}

/* ---------- リスト描画 ---------- */
function render(list){
  const el=document.getElementById('results');
  if(list.length === 0){
    el.innerHTML = '<div style="text-align:center;color:#666;margin:20px 0;">該当するホテルが見つかりませんでした</div>';
    return;
  }
  el.innerHTML=list.map(h=>
    `<div class='card' onclick='enlargeCard(${JSON.stringify(h).replace(/'/g, "\\'")})'>
      <div class='name'>${h.name}</div>
      <div>📍 ${h.address}</div>
      ${h.note?'<div>📝 '+h.note+'</div>':''}
      <div>🔍 <a href='https://www.google.com/search?q=${encodeURIComponent(h.name)}' target='_blank'>Google検索</a> ｜ 🗺️ <a href='${mapLink(h.name)}' target='_blank'>地図</a></div>
    </div>`
  ).join('');
}

/* ---------- 検索処理 ---------- */
function showInitials(g){
  const kana=['あ','か','さ','た','な','は','ま','や','ら','わ'];
  
  let filtered = [];
  
  if(kana.includes(g)){
    const ranges={
      'あ':/[あいうえおぁぃぅぇぉアァイィウゥエェオォヴ]/,
      'か':/[かきくけこがぎぐげごカキクケコガギグゲゴ]/,
      'さ':/[さしすせそサシスセソ]/,
      'た':/[たちつてとだぢづでどタチツテトダヂヅデド]/,
      'な':/[なにぬねのナニヌネノ]/,
      'は':/[はひふへほばびぶべぼぱぴぷぺぽハヒフヘホ]/,
      'ま':/[まみむめもマミムメモ]/,
      'や':/[やゆよゃゅょヤユヨ]/,
      'ら':/[らりるれろラリルレロ]/,
      'わ':/[わをんワヲン]/
    };
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = (h.name || '').replace(/^ホテル\s*/, '').trim().charAt(0);
      return ranges[g].test(firstChar);
    });
    
  } else {
    const map = {
      'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
      'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
    };
    const set = map[g] || '';
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = ((h.name || '').replace(/^ホテル\s*/, '').trim().charAt(0) || '').toUpperCase();
      return set.includes(firstChar);
    });
  }
  
  // 結果が3件以下の場合は直接表示
  if (filtered.length <= 3) {
    render(filtered);
    return;
  }
  
  // 2段階フィルタリング：キーワード選択
  showKeywordSelection(filtered, g);
}

/* ---------- ホテルブランド検索 ---------- */
function searchByBrand(brand){
  const filtered = DATA_ALL.filter(h => h.name.includes(brand));
  render(filtered);
}

/* ---------- キーワード選択 ---------- */
function showKeywordSelection(filtered, group) {
  const keywordMap = {};
  
  // ホテル名から抽出したキーワードを集計
  filtered.forEach(hotel => {
    const keywords = (hotel.keywords || '').split(' ').filter(k => k.trim() && k.length > 1);
    keywords.forEach(keyword => {
      if (!keywordMap[keyword]) {
        keywordMap[keyword] = [];
      }
      keywordMap[keyword].push(hotel);
    });
  });
  
  // キーワードを件数順にソート
  const sortedKeywords = Object.keys(keywordMap)
    .sort((a, b) => keywordMap[b].length - keywordMap[a].length);
  
  let contentHTML = '<h3>さらに絞り込む</h3>';
  
  if (sortedKeywords.length > 0) {
    contentHTML += sortedKeywords.map(keyword => {
      const count = keywordMap[keyword].length;
      return `<button onclick="selectKeyword('${keyword}', '${group}')">${keyword} (${count}件)</button>`;
    }).join('');
  }
  
  // 全件表示ボタン
  contentHTML += `<br><button onclick="showAllInGroup('${group}')" style="margin-top:10px;background:#eee;">全${filtered.length}件を表示</button>`;
  
  document.getElementById('overlay-content').innerHTML = contentHTML;
  document.getElementById('overlay').style.display = 'flex';
}

/* ---------- グループ全件表示 ---------- */
function showAllInGroup(group) {
  closeOverlay();
  
  let filtered = [];
  
  if(['あ','か','さ','た','な','は','ま','や','ら','わ'].includes(group)){
    const ranges={
      'あ':/[あいうえおぁぃぅぇぉアァイィウゥエェオォヴ]/,
      'か':/[かきくけこがぎぐげごカキクケコガギグゲゴ]/,
      'さ':/[さしすせそサシスセソ]/,
      'た':/[たちつてとだぢづでどタチツテトダヂヅデド]/,
      'な':/[なにぬねのナニヌネノ]/,
      'は':/[はひふへほばびぶべぼぱぴぷぺぽハヒフヘホ]/,
      'ま':/[まみむめもマミムメモ]/,
      'や':/[やゆよゃゅょヤユヨ]/,
      'ら':/[らりるれろラリルレロ]/,
      'わ':/[わをんワヲン]/
    };
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = (h.name || '').replace(/^ホテル\s*/, '').trim().charAt(0);
      return ranges[group].test(firstChar);
    });
  } else {
    const map = {
      'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
      'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
    };
    const set = map[group] || '';
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = ((h.name || '').replace(/^ホテル\s*/, '').trim().charAt(0) || '').toUpperCase();
      return set.includes(firstChar);
    });
  }
  
  render(filtered);
}

/* ---------- キーワードで絞り込み ---------- */
function selectKeyword(keyword, group) {
  closeOverlay();
  
  const matches = DATA_ALL.filter(h => {
    // グループフィルタリング
    const firstChar = (h.name || '').replace(/^ホテル\s*/, '').trim().charAt(0);
    const ranges = {
      'あ':/[あいうえおぁぃぅぇぉアァイィウゥエェオォヴ]/,
      'か':/[かきくけこがぎぐげごカキクケコガギグゲゴ]/,
      'さ':/[さしすせそサシスセソ]/,
      'た':/[たちつてとだぢづでどタチツテトダヂヅデド]/,
      'な':/[なにぬねのナニヌネノ]/,
      'は':/[はひふへほばびぶべぼぱぴぷぺぽハヒフヘホ]/,
      'ま':/[まみむめもマミムメモ]/,
      'や':/[やゆよゃゅょヤユヨ]/,
      'ら':/[らりるれろラリルレロ]/,
      'わ':/[わをんワヲン]/
    };
    
    let groupMatch = false;
    if (ranges[group]) {
      groupMatch = ranges[group].test(firstChar);
    } else {
      const map = {
        'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
        'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
      };
      const set = map[group] || '';
      groupMatch = set.includes(firstChar.toUpperCase());
    }
    
    // キーワードマッチング
    const keywordMatch = (h.keywords || '').includes(keyword);
    
    return groupMatch && keywordMatch;
  });
  
  render(matches);
}

/* ---------- オーバーレイ閉じる ---------- */
function closeOverlay() {
  document.getElementById('overlay').style.display = 'none';
}

// イベントリスナー設定
document.querySelectorAll('[data-g]').forEach(b=>b.addEventListener('click', e=>showInitials(e.target.getAttribute('data-g'))));

// ホテルブランドボタンのイベントリスナー
document.querySelectorAll('[data-brand]').forEach(b=>b.addEventListener('click', e=>searchByBrand(e.target.getAttribute('data-brand'))));

/* ---------- 拡大表示 ---------- */
function enlargeCard(h){
  const modal=document.getElementById('modal');
  const content=document.getElementById('modal-content');
  content.innerHTML=`
    <h2>${h.name}</h2>
    <p>📍 ${h.address}</p>
    ${h.note?'<p>📝 '+h.note+'</p>':''}
    <p>🔍 <a href='https://www.google.com/search?q=${encodeURIComponent(h.name)}' target='_blank'>Google検索</a></p>
    <p>🗺️ <a href='${mapLink(h.name)}' target='_blank'>地図</a></p>
    <button onclick="closeModal()">閉じる</button>`;
  modal.style.display='flex';
}
function closeModal(){document.getElementById('modal').style.display='none';}

/* ---------- QRコード ---------- */
document.getElementById('qrBtn').addEventListener('click',()=>{
  const url=location.origin+location.pathname;
  new QRious({element:document.getElementById('qrCanvas'),value:url,size:180});
  document.getElementById('qrModal').style.display='flex';
});
function closeQR(){document.getElementById('qrModal').style.display='none';}

/* ---------- ニュースライン ---------- */
function applyNews(){
  const p=new URLSearchParams(location.search);
  const joined=[p.get('news1'),p.get('news2'),p.get('news3')]
    .filter(Boolean).map(decodeURIComponent).join(' ／ ');
  document.getElementById('marqueeAll').textContent=joined||'　';
}
applyNews();

/* ---------- スピードメーター ---------- */
let speedWatchID=null;
document.getElementById('speedBtn').addEventListener('click',()=>{
  if(speedWatchID){
    navigator.geolocation.clearWatch(speedWatchID);
    speedWatchID=null;
    document.getElementById('speedArea').innerHTML='';
    return;
  }
  if(!navigator.geolocation){
    alert('この端末では速度を取得できません');
    return;
  }
  speedWatchID=navigator.geolocation.watchPosition(showSpeed,()=>alert('位置情報の取得を許可してください'),{enableHighAccuracy:true});
});
function showSpeed(pos){
  const spd=pos.coords.speed;
  const kmh=(spd||0)*3.6;
  const el=document.getElementById('speedArea');
  let color='white',size='40px';
  if(kmh>=63&&kmh<=65){color='yellow';size='60px';}
  else if(kmh>65){color='red';size='80px';}
  el.innerHTML=`<span style="font-size:${size};color:${color};">${kmh.toFixed(1)} km/h</span>`;
}

/* ---------- NHKニュースRSS ---------- */
const RSS_URL="https://www.nhk.or.jp/rss/news/cat0.xml";
async function fetchRSS(){
  try {
    // CORSプロキシを使用
    const proxyUrl = 'https://corsproxy.io/?';
    const response = await fetch(proxyUrl + encodeURIComponent(RSS_URL));
    
    if (!response.ok) throw new Error('Network response was not ok');
    
    const text = await response.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "text/xml");
    
    const items = xml.querySelectorAll("item");
    const news = Array.from(items).slice(0, 5).map(item => {
      const title = item.querySelector("title")?.textContent || "タイトルなし";
      const link = item.querySelector("link")?.textContent || "#";
      return { title, link };
    });

    const content = document.getElementById("newsContent");
    content.innerHTML = '';
    
    news.forEach((n, i) => {
      const prefix = i === 0 ? '🚨' : '📻';
      const el = document.createElement("span");
      el.innerHTML = `${prefix} <a href="${n.link}" target="_blank" style="color:#ffa500;text-decoration:none;border-bottom:1px dotted #ffa500;">${n.title}</a>`;
      content.appendChild(el);
      
      if (i < news.length - 1) {
        const sep = document.createElement("span");
        sep.textContent = " ● ";
        sep.style.color = "#ff4444";
        content.appendChild(sep);
      }
    });

    document.getElementById("updateTime").textContent = `更新: ${new Date().toLocaleTimeString()}`;
    
  } catch(e) {
    console.log("ニュース取得失敗:", e);
    document.getElementById("newsContent").innerHTML = "📻 ニュース取得に失敗しました";
  }
}

// ページ読み込み時にNHKニュースを取得
document.addEventListener('DOMContentLoaded', function() {
  fetchRSS();
  // 60秒ごとに更新
  setInterval(fetchRSS, 60000);
});
</script>
</body>
</html>