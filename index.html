<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æœ­å¹Œãƒ›ãƒ†ãƒ«ãƒªã‚¹ãƒˆ</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#c0c0c0">
<style>
body{
  font-family:Meiryo,'ãƒ¡ã‚¤ãƒªã‚ª',sans-serif;
  background:linear-gradient(145deg,#c0c0c0,#e0e0e0);
  margin:0;
  padding:16px;
}

/* ===== NHKãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆæœ€ä¸Šéƒ¨ï¼‰ ===== */
#newsBoard {
  background:#000;
  border-radius:5px;
  padding:6px 0;
  overflow:hidden;
  white-space:nowrap;
  text-align:left;
  margin:-8px -8px 10px -8px;
}
#newsContent {
  display:inline-block;
  padding-left:100%;
  color:#ffa500;
  font-family:'MS Gothic','Osaka-Mono',monospace;
  font-weight:bold;
  font-size:1.05em;
  animation: scrollNews 60s linear infinite;
}
@keyframes scrollNews {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}
#newsBoard:hover #newsContent { animation-play-state: paused; }

/* ===== æ›´æ–°æ—¥æ™‚ ===== */
#updateTime {
  text-align:right;
  font-size:0.8em;
  color:#000;
  opacity:0.7;
  margin:-5px 8px 10px 0;
}

h1{font-size:28px;text-shadow:0 1px 0 #fff;margin:8px 0;}
.metal{
  width:40px;height:40px;
  border-radius:50%;
  border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;margin:0 5px;
}
#topBtns{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}
#newsLine{margin:4px auto 10px;text-align:center;}
#newsTicker{overflow:hidden;white-space:nowrap;box-sizing:border-box;
  border-top:1px solid rgba(255,255,255,.35);
  border-bottom:1px solid rgba(0,0,0,.25);padding:6px 0;}
#newsTicker span{display:inline-block;padding-left:100%;
  animation:ticker 20s linear infinite;font-weight:700;
  font-size:1.05em;color:#222;}
@keyframes ticker{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}
.btns{display:grid;grid-template-columns:repeat(5,60px);
  gap:14px;justify-content:center;margin:10px auto;}
.metal-round{width:60px;height:60px;border-radius:50%;border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  font-weight:700;}
.alpha{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
  max-width:520px;margin:6px auto 12px;}
.long{padding:10px 20px;border-radius:9999px;border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);font-weight:700;}
#results{max-width:1000px;margin:10px auto;text-align:left;}
.card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:10px;margin:8px 0;}
.name{font-weight:700;}
#speedArea{text-align:center;font-weight:bold;margin:6px 0;}
#addHome{
  position:fixed;left:10px;bottom:10px;
  padding:8px 12px;border-radius:10px;border:2px solid #777;
  background:linear-gradient(#fff,#ccc);z-index:5;
}
#overlay,#modal,#qrModal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;
  align-items:center;justify-content:center;z-index:200;}
#overlay{background:rgba(0,0,0,0.7);z-index:100;}
#overlay-content{background:#fff;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto;text-align:center;position:relative;}
#overlay-content button{background:#fff;border:2px solid #999;border-radius:8px;color:#333;font-size:1.1em;padding:10px 15px;margin:5px;cursor:pointer;}
#overlay-close{position:absolute;top:10px;right:10px;background:#999;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer;}
#modal{background:rgba(0,0,0,0.8);}
#modal-content{background:#fff;padding:20px;border-radius:10px;max-width:90%;text-align:left;}
#qrModal{background:rgba(0,0,0,0.7);z-index:300;}
#qrBox{background:#fff;padding:20px;border-radius:10px;text-align:center;}
#qrBox canvas{width:180px;height:180px;}
.instruction{text-align:center;color:#666;margin:20px 0;font-size:16px;}

/* ãƒ›ãƒ†ãƒ«ãƒ–ãƒ©ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ */
.hotel-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 520px;
  margin: 12px auto 20px;
}
.hotel-btn {
  padding: 10px 0;
  border-radius: 6px;
  border: 2px solid #999;
  background: linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  font-weight: 700;
  font-size: 1em;
  box-shadow: 0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  cursor: pointer;
}

/* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ */
#bottomBtns{
  position:fixed;
  right:10px;
  bottom:10px;
  display:flex;
  gap:10px;
  z-index:10;
}
.metal-small{
  width:40px;height:40px;
  border-radius:50%;
  border:2px solid #999;
  background:linear-gradient(#fff,#d0d0d0 40%,#b0b0b0 60%,#e0e0e0);
  box-shadow:0 3px 6px rgba(0,0,0,.3),
              inset 0 2px 3px rgba(255,255,255,.7),
              inset 0 -3px 4px rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- ===== NHKãƒ‹ãƒ¥ãƒ¼ã‚¹é›»å…‰æ²ç¤ºæ¿ï¼ˆæœ€ä¸Šéƒ¨ï¼‰ ===== -->
<div id="newsBoard"><div id="newsContent">ğŸ“» NHKãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ä¸­...</div></div>
<div id="updateTime">æ›´æ–°: --:--</div>

<div id="topBtns">
  <button class="metal" onclick="location.href='bbs.html'">ğŸ’¬</button>
  <button class="metal" id="qrBtn">ğŸ“±</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=æ—¥ãƒãƒ +è©¦åˆçµæœ','_blank')">âš¾</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=æ–°åƒæ­³ç©ºæ¸¯+é‹è¡ŒçŠ¶æ³','_blank')">âœˆ</button>
  <button class="metal" onclick="window.open('https://www.google.com/search?q=æœ­å¹Œ+å¤©æ°—','_blank')">â˜</button>
  <button class="metal" id="speedBtn">ğŸ§­</button>
  <button class="metal" onclick="toggleAdmin()">âš™</button>
</div>

<div style="text-align:center;">
  <h1>æœ­å¹Œãƒ›ãƒ†ãƒ«ãƒªã‚¹ãƒˆ</h1>
</div>

<div id="newsLine"><div id="newsTicker"><span id="marqueeAll"></span></div></div>
<div id="speedArea"></div>

<div id="admin" style="display:none;text-align:center;margin-bottom:8px">
  <input type="password" id="pw" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹">
  <button onclick="checkAdmin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="btns" id="kanaBtns">
  <button class="metal-round" data-g="ã‚">ã‚</button><button class="metal-round" data-g="ã‹">ã‹</button><button class="metal-round" data-g="ã•">ã•</button><button class="metal-round" data-g="ãŸ">ãŸ</button><button class="metal-round" data-g="ãª">ãª</button><button class="metal-round" data-g="ã¯">ã¯</button><button class="metal-round" data-g="ã¾">ã¾</button><button class="metal-round" data-g="ã‚„">ã‚„</button><button class="metal-round" data-g="ã‚‰">ã‚‰</button><button class="metal-round" data-g="ã‚">ã‚</button>
</div>
<div class="alpha">
  <button class="long" data-g="ABCDE">ABCDE</button>
  <button class="long" data-g="FGHIJ">FGHIJ</button>
  <button class="long" data-g="KLMNO">KLMNO</button>
  <button class="long" data-g="PQRST">PQRST</button>
  <button class="long" data-g="UVWX">UVWX</button>
  <button class="long" data-g="YZ">YZ</button>
</div>

<!-- ãƒ›ãƒ†ãƒ«ãƒ–ãƒ©ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ -->
<div class="hotel-grid">
  <button class="hotel-btn" data-brand="ã‚¢ãƒ‘ãƒ›ãƒ†ãƒ«">ã‚¢ãƒ‘ãƒ›ãƒ†ãƒ«</button>
  <button class="hotel-btn" data-brand="æ±æ¨ªINN">æ±æ¨ªINN</button>
  <button class="hotel-btn" data-brand="ãƒã‚¤ã‚¹ãƒ†ã‚¤ã‚º">ãƒã‚¤ã‚¹ãƒ†ã‚¤ã‚º</button>
  <button class="hotel-btn" data-brand="ãƒªãƒ–ãƒãƒƒã‚¯ã‚¹">ãƒªãƒ–ãƒãƒƒã‚¯ã‚¹</button>
  <button class="hotel-btn" data-brand="ãƒ«ãƒ¼ãƒˆã‚¤ãƒ³">ãƒ«ãƒ¼ãƒˆã‚¤ãƒ³</button>
  <button class="hotel-btn" data-brand="RANDOR">RANDOR</button>
</div>

<div class="instruction">ğŸ” ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ¤œç´¢ã‚’å§‹ã‚ã¦ãã ã•ã„</div>
<div id="results"></div>

<div id="bottomBtns">
  <button class="metal-small" onclick="location.href='bbs.html'">ğŸ’¬</button>
  <button class="metal-small" onclick="toggleAdmin()">âš™ï¸</button>
</div>

<button id="addHome">ğŸ  ãƒ›ãƒ¼ãƒ ã«è¿½åŠ </button>

<div id="overlay">
  <div id="overlay-content">
    <button id="overlay-close" onclick="closeOverlay()">é–‰ã˜ã‚‹</button>
  </div>
</div>
<div id="modal"><div id="modal-content"></div></div>
<div id="qrModal"><div id="qrBox"><canvas id="qrCanvas"></canvas><br><button onclick="closeQR()">é–‰ã˜ã‚‹</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script>
/* ---------- ãƒ›ãƒ¼ãƒ è¿½åŠ å¯¾å¿œ ---------- */
let installPromptEvent=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  installPromptEvent=e;
});
document.getElementById('addHome').addEventListener('click',()=>{
  if(installPromptEvent){
    installPromptEvent.prompt();
    installPromptEvent.userChoice.then(()=>installPromptEvent=null);
  }else if(/iphone|ipad|ipod/i.test(navigator.userAgent)){
    alert('Safariã®å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
  }else{
    alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
  }
});

/* ---------- ç®¡ç†è€… ---------- */
function toggleAdmin(){
  const a=document.getElementById('admin');
  a.style.display=a.style.display==='block'?'none':'block';
}
function checkAdmin(){
  if(document.getElementById('pw').value==='bando')
    location.href='manual_entry_form.html';
  else alert('NG');
}

/* ---------- CSVèª­ã¿è¾¼ã¿ ---------- */
let DATA_ALL=[],DATA=[];
async function loadCSV(){
  try {
    const r=await fetch('hotels.csv');
    const t=await r.text();
    DATA_ALL=t.trim().split(/\r?\n/).filter(Boolean).map(l=>{
      const p=l.split(',');
      const hotelData = {
        initial:p[0]||'',
        name:p[1]||'',
        address:p[2]||'',
        note:p[3]||''
      };
      // ãƒ›ãƒ†ãƒ«åã ã‘ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
      hotelData.keywords = generateKeywordsFromName(hotelData.name);
      return hotelData;
    });
    DATA=DATA_ALL.slice();
    console.log('CSVèª­ã¿è¾¼ã¿æˆåŠŸ:', DATA_ALL.length + 'ä»¶');
  } catch(e) {
    console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    DATA_ALL = [];
    DATA = [];
  }
}
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«CSVã‚’èª­ã¿è¾¼ã‚€
loadCSV();

/* ---------- ãƒ›ãƒ†ãƒ«åã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ ---------- */
function generateKeywordsFromName(name) {
  return name
    .replace(/ãƒ›ãƒ†ãƒ«/g, ' ')
    .replace(/ã€ˆ/g, ' ')
    .replace(/ã€‰/g, ' ')
    .replace(/by/g, ' ')
    .replace(/[()ï¼ˆï¼‰]/g, ' ')
    .split(/\s+/)
    .filter(word => word && word.length > 1)
    .map(word => word.toLowerCase())
    .join(' ');
}

/* ---------- åœ°å›³ãƒªãƒ³ã‚¯ ---------- */
function mapLink(name){
  const ua=navigator.userAgent.toLowerCase();
  const q=encodeURIComponent(name);
  return /iphone|ipad|ipod/.test(ua)
    ? `maps://maps.apple.com/?q=${q}`
    : `https://www.google.com/maps/search/?api=1&query=${q}`;
}

/* ---------- ãƒªã‚¹ãƒˆæç”» ---------- */
function render(list){
  const el=document.getElementById('results');
  if(list.length === 0){
    el.innerHTML = '<div style="text-align:center;color:#666;margin:20px 0;">è©²å½“ã™ã‚‹ãƒ›ãƒ†ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    return;
  }
  el.innerHTML=list.map(h=>
    `<div class='card' onclick='enlargeCard(${JSON.stringify(h).replace(/'/g, "\\'")})'>
      <div class='name'>${h.name}</div>
      <div>ğŸ“ ${h.address}</div>
      ${h.note?'<div>ğŸ“ '+h.note+'</div>':''}
      <div>ğŸ” <a href='https://www.google.com/search?q=${encodeURIComponent(h.name)}' target='_blank'>Googleæ¤œç´¢</a> ï½œ ğŸ—ºï¸ <a href='${mapLink(h.name)}' target='_blank'>åœ°å›³</a></div>
    </div>`
  ).join('');
}

/* ---------- æ¤œç´¢å‡¦ç† ---------- */
function showInitials(g){
  const kana=['ã‚','ã‹','ã•','ãŸ','ãª','ã¯','ã¾','ã‚„','ã‚‰','ã‚'];
  
  let filtered = [];
  
  if(kana.includes(g)){
    const ranges={
      'ã‚':/[ã‚ã„ã†ãˆãŠããƒã…ã‡ã‰ã‚¢ã‚¡ã‚¤ã‚£ã‚¦ã‚¥ã‚¨ã‚§ã‚ªã‚©ãƒ´]/,
      'ã‹':/[ã‹ããã‘ã“ãŒããã’ã”ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚¬ã‚®ã‚°ã‚²ã‚´]/,
      'ã•':/[ã•ã—ã™ã›ãã‚µã‚·ã‚¹ã‚»ã‚½]/,
      'ãŸ':/[ãŸã¡ã¤ã¦ã¨ã ã¢ã¥ã§ã©ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰]/,
      'ãª':/[ãªã«ã¬ã­ã®ãƒŠãƒ‹ãƒŒãƒãƒ]/,
      'ã¯':/[ã¯ã²ãµã¸ã»ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ãƒãƒ’ãƒ•ãƒ˜ãƒ›]/,
      'ã¾':/[ã¾ã¿ã‚€ã‚ã‚‚ãƒãƒŸãƒ ãƒ¡ãƒ¢]/,
      'ã‚„':/[ã‚„ã‚†ã‚ˆã‚ƒã‚…ã‚‡ãƒ¤ãƒ¦ãƒ¨]/,
      'ã‚‰':/[ã‚‰ã‚Šã‚‹ã‚Œã‚ãƒ©ãƒªãƒ«ãƒ¬ãƒ­]/,
      'ã‚':/[ã‚ã‚’ã‚“ãƒ¯ãƒ²ãƒ³]/
    };
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = (h.name || '').replace(/^ãƒ›ãƒ†ãƒ«\s*/, '').trim().charAt(0);
      return ranges[g].test(firstChar);
    });
    
  } else {
    const map = {
      'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
      'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
    };
    const set = map[g] || '';
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = ((h.name || '').replace(/^ãƒ›ãƒ†ãƒ«\s*/, '').trim().charAt(0) || '').toUpperCase();
      return set.includes(firstChar);
    });
  }
  
  // çµæœãŒ3ä»¶ä»¥ä¸‹ã®å ´åˆã¯ç›´æ¥è¡¨ç¤º
  if (filtered.length <= 3) {
    render(filtered);
    return;
  }
  
  // 2æ®µéšãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é¸æŠ
  showKeywordSelection(filtered, g);
}

/* ---------- ãƒ›ãƒ†ãƒ«ãƒ–ãƒ©ãƒ³ãƒ‰æ¤œç´¢ ---------- */
function searchByBrand(brand){
  const filtered = DATA_ALL.filter(h => h.name.includes(brand));
  render(filtered);
}

/* ---------- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é¸æŠ ---------- */
function showKeywordSelection(filtered, group) {
  const keywordMap = {};
  
  // ãƒ›ãƒ†ãƒ«åã‹ã‚‰æŠ½å‡ºã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é›†è¨ˆ
  filtered.forEach(hotel => {
    const keywords = (hotel.keywords || '').split(' ').filter(k => k.trim() && k.length > 1);
    keywords.forEach(keyword => {
      if (!keywordMap[keyword]) {
        keywordMap[keyword] = [];
      }
      keywordMap[keyword].push(hotel);
    });
  });
  
  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä»¶æ•°é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedKeywords = Object.keys(keywordMap)
    .sort((a, b) => keywordMap[b].length - keywordMap[a].length);
  
  let contentHTML = '<h3>ã•ã‚‰ã«çµã‚Šè¾¼ã‚€</h3>';
  
  if (sortedKeywords.length > 0) {
    contentHTML += sortedKeywords.map(keyword => {
      const count = keywordMap[keyword].length;
      return `<button onclick="selectKeyword('${keyword}', '${group}')">${keyword} (${count}ä»¶)</button>`;
    }).join('');
  }
  
  // å…¨ä»¶è¡¨ç¤ºãƒœã‚¿ãƒ³
  contentHTML += `<br><button onclick="showAllInGroup('${group}')" style="margin-top:10px;background:#eee;">å…¨${filtered.length}ä»¶ã‚’è¡¨ç¤º</button>`;
  
  document.getElementById('overlay-content').innerHTML = contentHTML;
  document.getElementById('overlay').style.display = 'flex';
}

/* ---------- ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä»¶è¡¨ç¤º ---------- */
function showAllInGroup(group) {
  closeOverlay();
  
  let filtered = [];
  
  if(['ã‚','ã‹','ã•','ãŸ','ãª','ã¯','ã¾','ã‚„','ã‚‰','ã‚'].includes(group)){
    const ranges={
      'ã‚':/[ã‚ã„ã†ãˆãŠããƒã…ã‡ã‰ã‚¢ã‚¡ã‚¤ã‚£ã‚¦ã‚¥ã‚¨ã‚§ã‚ªã‚©ãƒ´]/,
      'ã‹':/[ã‹ããã‘ã“ãŒããã’ã”ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚¬ã‚®ã‚°ã‚²ã‚´]/,
      'ã•':/[ã•ã—ã™ã›ãã‚µã‚·ã‚¹ã‚»ã‚½]/,
      'ãŸ':/[ãŸã¡ã¤ã¦ã¨ã ã¢ã¥ã§ã©ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰]/,
      'ãª':/[ãªã«ã¬ã­ã®ãƒŠãƒ‹ãƒŒãƒãƒ]/,
      'ã¯':/[ã¯ã²ãµã¸ã»ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ãƒãƒ’ãƒ•ãƒ˜ãƒ›]/,
      'ã¾':/[ã¾ã¿ã‚€ã‚ã‚‚ãƒãƒŸãƒ ãƒ¡ãƒ¢]/,
      'ã‚„':/[ã‚„ã‚†ã‚ˆã‚ƒã‚…ã‚‡ãƒ¤ãƒ¦ãƒ¨]/,
      'ã‚‰':/[ã‚‰ã‚Šã‚‹ã‚Œã‚ãƒ©ãƒªãƒ«ãƒ¬ãƒ­]/,
      'ã‚':/[ã‚ã‚’ã‚“ãƒ¯ãƒ²ãƒ³]/
    };
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = (h.name || '').replace(/^ãƒ›ãƒ†ãƒ«\s*/, '').trim().charAt(0);
      return ranges[group].test(firstChar);
    });
  } else {
    const map = {
      'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
      'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
    };
    const set = map[group] || '';
    
    filtered = DATA_ALL.filter(h => {
      const firstChar = ((h.name || '').replace(/^ãƒ›ãƒ†ãƒ«\s*/, '').trim().charAt(0) || '').toUpperCase();
      return set.includes(firstChar);
    });
  }
  
  render(filtered);
}

/* ---------- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ ---------- */
function selectKeyword(keyword, group) {
  closeOverlay();
  
  const matches = DATA_ALL.filter(h => {
    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const firstChar = (h.name || '').replace(/^ãƒ›ãƒ†ãƒ«\s*/, '').trim().charAt(0);
    const ranges = {
      'ã‚':/[ã‚ã„ã†ãˆãŠããƒã…ã‡ã‰ã‚¢ã‚¡ã‚¤ã‚£ã‚¦ã‚¥ã‚¨ã‚§ã‚ªã‚©ãƒ´]/,
      'ã‹':/[ã‹ããã‘ã“ãŒããã’ã”ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚¬ã‚®ã‚°ã‚²ã‚´]/,
      'ã•':/[ã•ã—ã™ã›ãã‚µã‚·ã‚¹ã‚»ã‚½]/,
      'ãŸ':/[ãŸã¡ã¤ã¦ã¨ã ã¢ã¥ã§ã©ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰]/,
      'ãª':/[ãªã«ã¬ã­ã®ãƒŠãƒ‹ãƒŒãƒãƒ]/,
      'ã¯':/[ã¯ã²ãµã¸ã»ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ãƒãƒ’ãƒ•ãƒ˜ãƒ›]/,
      'ã¾':/[ã¾ã¿ã‚€ã‚ã‚‚ãƒãƒŸãƒ ãƒ¡ãƒ¢]/,
      'ã‚„':/[ã‚„ã‚†ã‚ˆã‚ƒã‚…ã‚‡ãƒ¤ãƒ¦ãƒ¨]/,
      'ã‚‰':/[ã‚‰ã‚Šã‚‹ã‚Œã‚ãƒ©ãƒªãƒ«ãƒ¬ãƒ­]/,
      'ã‚':/[ã‚ã‚’ã‚“ãƒ¯ãƒ²ãƒ³]/
    };
    
    let groupMatch = false;
    if (ranges[group]) {
      groupMatch = ranges[group].test(firstChar);
    } else {
      const map = {
        'ABCDE':'ABCDE','FGHIJ':'FGHIJ','KLMNO':'KLMNO',
        'PQRST':'PQRST','UVWX':'UVWX','YZ':'YZ'
      };
      const set = map[group] || '';
      groupMatch = set.includes(firstChar.toUpperCase());
    }
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
    const keywordMatch = (h.keywords || '').includes(keyword);
    
    return groupMatch && keywordMatch;
  });
  
  render(matches);
}

/* ---------- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–‰ã˜ã‚‹ ---------- */
function closeOverlay() {
  document.getElementById('overlay').style.display = 'none';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
document.querySelectorAll('[data-g]').forEach(b=>b.addEventListener('click', e=>showInitials(e.target.getAttribute('data-g'))));

// ãƒ›ãƒ†ãƒ«ãƒ–ãƒ©ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.querySelectorAll('[data-brand]').forEach(b=>b.addEventListener('click', e=>searchByBrand(e.target.getAttribute('data-brand'))));

/* ---------- æ‹¡å¤§è¡¨ç¤º ---------- */
function enlargeCard(h){
  const modal=document.getElementById('modal');
  const content=document.getElementById('modal-content');
  content.innerHTML=`
    <h2>${h.name}</h2>
    <p>ğŸ“ ${h.address}</p>
    ${h.note?'<p>ğŸ“ '+h.note+'</p>':''}
    <p>ğŸ” <a href='https://www.google.com/search?q=${encodeURIComponent(h.name)}' target='_blank'>Googleæ¤œç´¢</a></p>
    <p>ğŸ—ºï¸ <a href='${mapLink(h.name)}' target='_blank'>åœ°å›³</a></p>
    <button onclick="closeModal()">é–‰ã˜ã‚‹</button>`;
  modal.style.display='flex';
}
function closeModal(){document.getElementById('modal').style.display='none';}

/* ---------- QRã‚³ãƒ¼ãƒ‰ ---------- */
document.getElementById('qrBtn').addEventListener('click',()=>{
  const url=location.origin+location.pathname;
  new QRious({element:document.getElementById('qrCanvas'),value:url,size:180});
  document.getElementById('qrModal').style.display='flex';
});
function closeQR(){document.getElementById('qrModal').style.display='none';}

/* ---------- ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ ---------- */
function applyNews(){
  const p=new URLSearchParams(location.search);
  const joined=[p.get('news1'),p.get('news2'),p.get('news3')]
    .filter(Boolean).map(decodeURIComponent).join(' ï¼ ');
  document.getElementById('marqueeAll').textContent=joined||'ã€€';
}
applyNews();

/* ---------- ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ ---------- */
let speedWatchID=null;
document.getElementById('speedBtn').addEventListener('click',()=>{
  if(speedWatchID){
    navigator.geolocation.clearWatch(speedWatchID);
    speedWatchID=null;
    document.getElementById('speedArea').innerHTML='';
    return;
  }
  if(!navigator.geolocation){
    alert('ã“ã®ç«¯æœ«ã§ã¯é€Ÿåº¦ã‚’å–å¾—ã§ãã¾ã›ã‚“');
    return;
  }
  speedWatchID=navigator.geolocation.watchPosition(showSpeed,()=>alert('ä½ç½®æƒ…å ±ã®å–å¾—ã‚’è¨±å¯ã—ã¦ãã ã•ã„'),{enableHighAccuracy:true});
});
function showSpeed(pos){
  const spd=pos.coords.speed;
  const kmh=(spd||0)*3.6;
  const el=document.getElementById('speedArea');
  let color='white',size='40px';
  if(kmh>=63&&kmh<=65){color='yellow';size='60px';}
  else if(kmh>65){color='red';size='80px';}
  el.innerHTML=`<span style="font-size:${size};color:${color};">${kmh.toFixed(1)} km/h</span>`;
}

/* ---------- NHKãƒ‹ãƒ¥ãƒ¼ã‚¹RSS ---------- */
const RSS_URL="https://www.nhk.or.jp/rss/news/cat0.xml";
async function fetchRSS(){
  try {
    // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
    const proxyUrl = 'https://corsproxy.io/?';
    const response = await fetch(proxyUrl + encodeURIComponent(RSS_URL));
    
    if (!response.ok) throw new Error('Network response was not ok');
    
    const text = await response.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "text/xml");
    
    const items = xml.querySelectorAll("item");
    const news = Array.from(items).slice(0, 5).map(item => {
      const title = item.querySelector("title")?.textContent || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";
      const link = item.querySelector("link")?.textContent || "#";
      return { title, link };
    });

    const content = document.getElementById("newsContent");
    content.innerHTML = '';
    
    news.forEach((n, i) => {
      const prefix = i === 0 ? 'ğŸš¨' : 'ğŸ“»';
      const el = document.createElement("span");
      el.innerHTML = `${prefix} <a href="${n.link}" target="_blank" style="color:#ffa500;text-decoration:none;border-bottom:1px dotted #ffa500;">${n.title}</a>`;
      content.appendChild(el);
      
      if (i < news.length - 1) {
        const sep = document.createElement("span");
        sep.textContent = " â— ";
        sep.style.color = "#ff4444";
        content.appendChild(sep);
      }
    });

    document.getElementById("updateTime").textContent = `æ›´æ–°: ${new Date().toLocaleTimeString()}`;
    
  } catch(e) {
    console.log("ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—:", e);
    document.getElementById("newsContent").innerHTML = "ğŸ“» ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«NHKãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—
document.addEventListener('DOMContentLoaded', function() {
  fetchRSS();
  // 60ç§’ã”ã¨ã«æ›´æ–°
  setInterval(fetchRSS, 60000);
});
</script>
</body>
</html>